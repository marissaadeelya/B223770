---
title: "To what extent do seasonal trends in salbutamol prescribing differ across Scottish regions, and how are these patterns shaped by population sex and age distributions?"
author: "Marissa Adeelya Mansor"
date: "26 November 2025"
output:
  html_document:
    toc: true
    toc_float: true
    theme: lumen
    code_download: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = FALSE, message = FALSE)
```

## Background: Respiratory Conditions and Salbutamol
Emergency admissions for respiratory diseases, including asthma and chronic obstructive pulmonary disease (COPD), have increased in recent years. In 2024, England recorded 854,922 emergency admissions, representing a 7% rise from the previous year (UK Government, 2025)(https://www.gov.uk/government/statistics/update-of-indicators-in-the-respiratory-disease-profile-june-2025/respiratory-disease-profile-statistical-commentary-june-2025).

To reduce hospitalisations and manage symptoms, salbutamol is widely used as the first selective short-acting β₂-agonist (SABA) for asthma treatment. It relaxes airway smooth muscle, improving breathing during episodes of respiratory distress or flare-ups. Salbutamol is considered one of the most effective and safest essential medicines and is available in several formulations, including inhalers, nebulisers, and tablets (Marques and Vale,2022)(https://pmc.ncbi.nlm.nih.gov/articles/PMC9696300/).

## Study Motivation: Seasonal Trends in Respiratory Medication
A study in Syria reported seasonal variation in the dispensing of medicines for asthma and COPD, with higher rates in autumn and winter and lower rates in summer (Aljadeeah et al., 2025)(https://doi.org/10.1080/16549716.2025.2556526).Building on these findings, this report investigates seasonal patterns in salbutamol prescribing across Scotland and examines NHS Board-level population structures, focusing on age and sex distributions, to provide context for potential differences in prescribing trends.

## About the Data
The prescription data used in this study were obtained from Public Health Scotland, specifically from the Data by Prescriber Location dataset: (https://www.opendata.nhs.scot/dataset/prescriptions-in-the-community). 24 monthly files (June 2023–May 2025) were analysed, representing two full seasonal cycles and offering detailed records of community prescriptions.To allow reproducibility, the download links for all 24 CSV files were compiled into a single CSV file and made available via GitHub.

```{r Load libraries and data from June 2023 to May 2025}
library(tidyverse)
library(janitor)
library(here)
library(gt)

# Read URL list from GitHub csv file for reproducibility
urls_list <- read_csv( "https://raw.githubusercontent.com/marissaadeelya/B223770/main/urls.csv") %>%
  pull(url)

# Introducing data from June 2023 to May 2025 
consecutive_data <- urls_list %>% 
  map_dfr(~ read_csv(.x, col_types = cols(.default = col_character()))) %>%
  clean_names() %>%
  select(hbt, bnf_item_description, paid_quantity, paid_date_month)
```

### Introducing Salbutamol Data by Season (June 2023 - May 2025)
This section filters data to focus only on salbutamol prescriptions, excluding the non-official NHS health board code (SB0806). 

```{r Classify salbutamol prescription by season}
# Create 'summarise_prescriptions' function to reapply in other dataset
summarise_prescriptions <- function(data, ..., qty_var, new_var) {
  data %>%
    group_by(...) %>%
    summarise(
      !!new_var := sum(.data[[qty_var]], na.rm = TRUE), 
      .groups = "drop")}
  # := creates a new column
  # !! unquotes the name stored in new_var so it becomes the column name.

# Filter salbutamol prescription and classify months
salbutamol_data <- consecutive_data %>%
  filter(
    str_detect(bnf_item_description, "SALBUTAMOL"),
    hbt != "SB0806") %>%
  mutate(
    paid_quantity = as.numeric(paid_quantity),
    paid_date_month = parse_date_time(paid_date_month, "ym"),
    month_number = month(paid_date_month),
    year = case_when(
      month_number >= 6 ~ paste0(year(paid_date_month), "/", year(paid_date_month) + 1),
      TRUE ~ paste0(year(paid_date_month) - 1, "/", year(paid_date_month))),
    # paste0() joins text together with no spaces between words.
    
    season = case_when(
      month_number %in% c(12, 1, 2) ~ "Winter",
      month_number %in% c(3, 4, 5) ~ "Spring",
      month_number %in% c(6, 7, 8) ~ "Summer",
      month_number %in% c(9, 10, 11) ~ "Autumn"),
    season = factor(season, levels = c("Summer", "Autumn", "Winter", "Spring"))) %>%
  
  summarise_prescriptions(    # apply function
    paid_date_month, hbt, bnf_item_description, season, year,
    qty_var = "paid_quantity",
    new_var = "total_prescriptions")
```

## Aim 1: To investigate if salbutamol prescriptions fluctuate by season across Scotland.
The dataset was generated by aggregating all salbutamol prescriptions, irrespective of formulation type, across all Scottish Health Boards. This provides a national-level perspective on seasonal variation, as illustrated in Figure 1.

### Figure 1: Seasonal Trend of Salbutamol Prescriptions Across Scotland
```{r figure1, fig.width=7, fig.height=4}

# Aggregate data across all boards for seasonal national-level view
# Apply function 'summarise_prescriptions'
seasonal_salbutamol <- salbutamol_data %>%
  summarise_prescriptions(season, year,qty_var = "total_prescriptions", 
                          new_var = "total_prescriptions")

# Define a custom plotting function for line charts
line_charts_custom <- function(df, x_var, y_var, colour_var, group_var,size, y_label, title, base_size) 
  { df %>% 
    ggplot(aes(
      x = {{ x_var }},
      y = {{ y_var }},
      colour = {{ colour_var }},
      group = {{ group_var }} )) +
    geom_line(linewidth = 1.2) +
    geom_point(size=size) +
    scale_y_continuous(labels = scales::label_comma(accuracy = 1)) +
    scale_color_brewer(palette = "Set1") +
    labs(
      title = title,
      subtitle = "Each line represents a June–May year period",  
      x = "Season",
      y = y_label,
      colour = "Year Group (June–May)") +
    theme_bw(base_size) +
    theme(
      plot.title = element_text(face = "bold", size = 13, hjust = 0.5),
      plot.subtitle = element_text(hjust = 0.5),
      axis.text.x = element_text(angle = 30, hjust = 1),
      legend.position ="bottom",
      legend.text = element_text(size = 11),strip.text = element_text(face ="bold"))}

# Plot Figure 1 (Prescription Seasonal Trend in Scotland) 
# Apply function 'line_charts_custom'
plot_seasonal_trend <- seasonal_salbutamol %>% 
  line_charts_custom(season, total_prescriptions, year,year, 4, "Total Prescriptions", "Seasonal Distribution of Salbutamol Prescriptions in Scotland", 12)

plot_seasonal_trend 

```

Figure 1 shows a clear seasonal pattern in salbutamol prescribing across Scotland, with peaks in winter, steady levels through summer and autumn, and a pronounced decline each spring. Winter peaks reflect cold, damp conditions and high circulation of respiratory viruses, both of which exacerbate asthma symptoms. The spring decline occurs as viral activity drops, temperatures rise, and respiratory irritation lessens. Prescribing increases again in late spring and early summer with the onset of the grass pollen season.

Overall prescribing is lower this year than last year, which may reflect updated clinical guidelines that advise against prescribing SABA, including salbutamol, on its own without a concurrent inhaled corticosteroid, and instead recommend anti-inflammatory reliever (AIR) therapy as a safer alternative for long-term asthma management (UK Government, 2025)(https://www.gov.uk/drug-safety-update/short-acting-beta-2-agonists-saba-salbutamol-and-terbutaline-reminder-of-the-risks-from-overuse-in-asthma-and-to-be-aware-of-changes-in-the-saba-prescribing-guidelines#).

## Aim 2: To compare seasonal salbutamol prescription trends across NHS Boards.
The next step is to assess whether this seasonal pattern is consistent across different NHS Boards. To enable this, the Health Board names dataset from the Public Health Scotland Open Data platform is incorporated so that each prescription record can be matched to its corresponding Board.

Because total prescription counts are influenced by population size, comparisons across Boards require standardisation. Prescription rates were therefore calculated per head using NHS Board population estimates.For this, an additional population dataset from the 2022 Census is needed. The file UV102a_age_health_board_census.csv, which provides NHS Board populations by age group and sex, should be downloaded from Scotland’s Census website (https://www.scotlandscensus.gov.uk/webapi/jsf/tableView/tableView.xhtml) in csv format and saved in the project’s data folder.

```{r Load healthboard and population dataset}

# Healthboard data
hb_lookup <-
  read_csv("https://www.opendata.nhs.scot/dataset/9f942fdb-e59e-44f5-b534-d6e17229cc7b/resource/652ff726-e676-4a20-abda-435b98dd7bdc/download/hb14_hb19.csv",
  col_types = cols(.default = col_character())) %>%
  clean_names() %>%
  select(hb, hb_name) %>%
  filter(!duplicated(hb_name))

# Population data
population_data <-read_csv( here("data", "UV102a_age_health_board_census.csv"),
    skip = 10,
    col_types = cols(.default = col_character())) %>%
  clean_names() %>%
  rename(spare = x6,
         hb_name = health_board_area_2019,
         hb_population = count) %>%
  mutate(hb_name = paste("NHS", hb_name)) %>%
  filter(!is.na(hb_population)) %>%
  select(-spare, hb_name, age, sex, hb_population)
```

To examine whether regional factors contribute to differences in prescribing trends between NHS Boards, the Boards are grouped into broader geographic regions (North, Central, and South) following the NHS Health Board Scotland classifications.

```{r Categorise NHS boards into regions}

# A reusable function (add_region) was created to assign NHS Boards to regions in different datasets. 
add_region <- function(df) {
  df %>% mutate(
      region = case_when(
        hb_name %in% c( "NHS Highland", "NHS Grampian", "NHS Tayside",
          "NHS Orkney", "NHS Shetland", "NHS Western Isles") ~ "North",
        hb_name %in% c("NHS Greater Glasgow and Clyde", "NHS Lanarkshire",
          "NHS Ayrshire and Arran", "NHS Forth Valley") ~ "Central",
        hb_name %in% c("NHS Lothian", "NHS Borders", "NHS Fife",
          "NHS Dumfries and Galloway") ~ "South",TRUE ~ "Other"))}
```

The integration of the prescription, Health Board, and population datasets enables analysis of regional differences in prescribing trends, as shown in Figure 2.

### Figure 2: Seasonal Salbutamol Prescriptions per Head by NHS Boards
```{r figure2, fig.width=8, fig.height= 6 }

# Join healthboard dataset
hb_per_head_salbutamol_data <- salbutamol_data %>% 
  left_join(hb_lookup, by = c("hbt"="hb")) %>% 
  filter(!is.na(hb_name)) %>% 
  select(hbt,hb_name, season, year, total_prescriptions) %>% 

# Join population dataset and calculate prescriptions per head
  left_join(population_data %>% 
      filter(age == "All people", sex == "All people") %>% 
      distinct(hb_name, .keep_all = TRUE) %>% 
      mutate(hb_population = as.numeric(hb_population)),  
    by = "hb_name") %>%  
  group_by(hb_name, season, year) %>% 
  summarise(
    prescriptions_per_head = sum(total_prescriptions, na.rm = TRUE) /unique(hb_population),
    .groups = "drop") %>% 
  
add_region() # Add region classification (apply function)

# Plot Figure 2 to show seasonal prescriptions by NHS Boards (apply 'line_charts' function)
plot_hb_trend_per_head <- hb_per_head_salbutamol_data %>%
  line_charts_custom(
    season,prescriptions_per_head,
    factor(year),interaction(hb_name, year), 2, 
    "Total Prescriptions per Head",
    "Seasonal Salbutamol Prescriptions per Head by NHS Boards", 10) +
  
  facet_wrap(region ~ hb_name, scales = "free_y") + 
  labs(caption = "Note: NHS Boards are categorised into three regions - Central, North and South") +
  theme(plot.caption = element_text(size = 12,hjust = 0.5))

plot_hb_trend_per_head
```

Figure 2 shows that most NHS Boards follow a clear seasonal pattern, with winter peaks and spring declines in salbutamol prescribing. Notable deviations include NHS Forth Valley and NHS Western Isles, where prescribing remains relatively stable from autumn to spring, and NHS Shetland, which exhibits a winter decrease. The highest winter rates are observed in NHS Ayrshire and Arran (Central, up to 28 prescriptions per head), followed by NHS Borders and NHS Dumfries and Galloway (South, up to 27 per head). In contrast, the northern Boards (NHS Orkney, NHS Shetland, NHS Grampian, and NHS Highland) show the lowest winter rates.

Despite colder winters, northern Scotland shows lower salbutamol prescribing than central and southern regions, likely due to lower population density, less urbanisation, reduced pollution or allergen exposure, and longer distances to healthcare, while central and southern areas’ higher urbanisation and healthcare access may drive greater prescribing.

## Aim 3:  To examine population structure by age and sex across NHS Boards for contextual understanding
While differences in prescribing patterns across NHS Boards can be partially explained by regional factors, a broader understanding of population structure is also important for contextualising health-related outcomes. Therefore, the third aim of this study is to examine the demographic composition of Scotland’s population, focusing on age and sex distribution across NHS Boards.

However, since age-specific prescription counts were not available, this analysis is not directly related to salbutamol prescribing. Nevertheless, it provides essential context for future studies on respiratory health, service planning, and the interpretation of regional variations in healthcare utilisation.Considering that the dataset provides individual counts by age and sex, age groups were defined to facilitate a more meaningful and manageable analysis.

```{r Age group setup}

population_summary <- population_data %>%
  mutate(
    hb_population = as.numeric(hb_population),
    age_group = case_when(
      age == "Under 1" ~ "0-1",
      age %in% as.character(1:17)  ~ "1-17",
      age %in% as.character(18:39) ~ "18-39",
      age %in% as.character(40:64) ~ "40-64",
      age %in% as.character(65:84) ~ "65-84",
      age == "85 and over" ~ "85+"),
    age_group = factor(age_group, 
                       levels = c("0-1","1-17","18-39","40-64","65-84","85+"))) %>%
  
  add_region() %>%  #apply function
  filter(!is.na(age_group), sex %in% c("Female", "Male")) %>%
  
  #apply function
  summarise_prescriptions(region, hb_name, age_group, sex, 
      qty_var = "hb_population", new_var = "population") 
```

Population data were processed to calculate total population by region and the percentage of each sex within age groups, enabling identification of regions with the largest populations and their dominant age groups and sexes.

```{r Prepare population data}

# Summarise population across all NHS boards in a region
region_population <- population_summary %>%
  group_by(region, age_group, sex) %>%
  summarise(population = sum(population), .groups = "drop") %>%
  
# Calculate total population for each region and the percentage contributed by each NHS board 
  group_by(region) %>%
  mutate(
    region_total = sum(population),
    percentage = (population / region_total) * 100) %>%
  ungroup()

region_table <- region_population %>%
  select(region, age_group, sex, percentage, region_total) %>%
  pivot_wider(
    names_from = sex,
    values_from = percentage) %>%
  group_by(region, age_group) %>%
  summarise(across(c(Male, Female), sum), .groups = "drop") %>%
  
# Pivot regions to columns (Male_Region, Female_Region)
  pivot_wider(
    names_from = region,
    values_from = c(Male, Female),
    names_sep = "_") %>%
  arrange(match(age_group, c("0-1","1-17","18-39","40-64","65-84","85+"))) %>% 

# Add total row
  bind_rows(summarise(.,
      across(where(is.numeric), ~ sum(.x, na.rm = TRUE)),
      age_group = "Total"))
   # bind_rows() stacks rows
   # across(where(is.numeric), ~ ...) applies the function to all numeric columns.

# Identify max age group (excluding Total)
max_age <- region_table %>%
  filter(age_group != "Total") %>%
  rowwise() %>%   # to find maximum value row by row
  mutate(
    max_val = max(c_across(where(is.numeric)), na.rm = TRUE)) %>%
  ungroup() %>%
  slice_max(max_val) %>%
  pull(age_group)
```

### Figure 3: Table showing population distribution by sex and age group across Scottish regions.
```{r figure3}

# create function to apply consistent styling
apply_style <- function(df, fill_col, text_col, locations) {
  df %>% 
    gt::tab_style(
      style = list(
        cell_fill(color = fill_col),
        cell_text(color = text_col, weight = "bold", size = "large")),
      locations = {{ locations }})}

# create function to include region spanner with total population
add_total_region <- function(gt_table, region_name, male_col, female_col, data) {
  gt_table %>%
    tab_spanner(
      label = gt::html(paste0(
          region_name, " (%)", ",<br>n = ", 
    #",<br>n = " → adds a line break in spanner between region and the n = prefix for the                     total population.
          
          format(data$region_total[data$region == region_name][1],
                 big.mark = ",", scientific = FALSE))),
          columns = c(male_col, female_col))}
    # format(): converts number to readable text, big.mark adds commas between large numbers.
    # scientific = FALSE prevents scientific notation (keeps 1000000 instead of "1e+06")
    # [1] selects a single value for multiple rows exist in the region.

# generate the GT table (figure 3)
region_gt_table <- region_table %>%
  gt() %>%
  fmt_number(columns = where(is.numeric), decimals = 2) %>%
  tab_header(
    title = "Population by Region and Age Group",
    subtitle = "Distribution of population percentages by sex within each region") %>%
  
  # Create region-based column groups for each sex, including total population
  # Apply function to include region spanner with population number
  add_total_region("North", "Male_North", "Female_North", region_population) %>%
  add_total_region("Central", "Male_Central", "Female_Central", region_population) %>%
  add_total_region("South", "Male_South", "Female_South", region_population) %>%
  
  cols_label(
    Male_North = "Male", Female_North = "Female",
    Male_Central = "Male",Female_Central = "Female",
    Male_South = "Male",Female_South = "Female",age_group = "Age Group") %>%
  
  # Utilise apply_style function 
  apply_style("darkblue","white", cells_title(groups = "title")) %>% 
  apply_style("lightblue","black", cells_title(groups = "subtitle")) %>% 
  apply_style("orange","black", cells_body(rows = age_group == max_age)) %>% 
  apply_style("grey","black", cells_body(rows = age_group == "Total")) %>%

  cols_align(align = "center", columns = everything()) %>%
  tab_source_note(
    source_note = "All values represent the percentage of the total population within each region. The orange-highlighted row indicates the age group with the highest population proportion in that region.") %>%
  
  cols_width(everything() ~ px(95)) 
  
region_gt_table

```

The table shows that the central region has the highest population, markedly higher than the southern region, while the northern region has the lowest population.Across all regions, the population is predominantly aged 40–64 years, with the fewest individuals in the 0–1 and 85+ age groups. For sex distribution, there are slightly greater female population than male. To gain deeper insight into the age and sex distribution within each region, a heatmap was created to show population details for each NHS board using the raw population counts.

### Figure 4: Population Heatmap by Region, NHS Boards, Age Group, and Sex
```{r figure4, fig.width= 8}

heatmap <- ggplot(population_summary, aes(
  x = age_group,
  y = hb_name,
  fill = population)) +
  geom_tile() +

  # Apply a log-scale colour to improve visibility of large differences in population.
  scale_fill_distiller(
    palette = "RdBu",
    direction = -1,               # -1 = blue low to red high
    trans = "log10",
    name = "Population\n",
    labels = scales::label_number(scale_cut = scales::cut_short_scale())) +
  # use cut_short_scale() to label legend in 1k, 10k, etc.
 
  facet_grid(region ~ sex, scales = "free_y", space = "free_y") +
  labs(
    title = "Population Heatmap by Region, NHS Boards, Age Group, and Sex",
    x = "Age Group",
    y = "NHS Board",
    caption = "Note: Colour intensity is based on log10 of raw population counts to improve visibility") +

  theme_minimal() +
  theme(
    plot.caption = element_text(size = 11,hjust = 0.5),
    axis.text.y = element_text(size = 7),
    strip.text = element_text(face = "bold", size = 10),
    plot.title = element_text(face = "bold", hjust = 0.5))

heatmap
```

Figure 4 shows consistent demographic patterns across NHS Boards, with populations concentrated in the 40–64 age group and the fewest individuals in the 0–1 and 85+ categories. Although the table indicates a slightly higher overall female population, age-group distributions are broadly similar between sexes, with the main difference being a higher proportion of females in the 85+ group.

Reflecting the central region’s larger population, NHS Greater Glasgow and Clyde contributes the greatest share, particularly among individuals aged 18–39 and 40–64. Other central Boards also show higher populations across most age groups, except the 0–1 and 85+ groups. By contrast, northern Boards generally have lower population densities, with slightly higher counts in NHS Tayside, NHS Highland, and NHS Grampian, and the lowest populations in NHS Western Isles, NHS Shetland, and NHS Orkney. The southern region displays intermediate population densities, with NHS Lothian and NHS Fife notably larger than NHS Borders and NHS Dumfries and Galloway.

## Limitations
The prescribing data lack age and sex, preventing linkage to specific demographic groups. Salbutamol prescribing is aggregated at board level, so it is not possible to determine which groups drive overall or seasonal trends. Estimating prescriptions from population size would be inappropriate, as prescribing reflects disease prevalence and severity rather than population alone. All interpretations are therefore limited to the board level.

## Conclusion and Future Direction
Salbutamol prescribing in Scotland shows a clear seasonal pattern, peaking in winter, stable through summer and autumn, and declining in spring. Winter prescriptions are highest in the central region, followed by the south and lowest in the north, suggesting that factors beyond cold, such as urbanisation, population density, environment, and healthcare access affect prescribing. Population distributions are broadly similar across boards, mostly aged 40–64, fewest in 0–1 and 85+, and slightly more females. However,lack of age- and sex-specific prescribing data limits detailed analysis, but population data still inform trend interpretation and resource planning. Future studies with age and sex stratified prescribing data could provide more precise insights, supporting targeted clinical guidelines and healthcare service allocation.

## References
Aljadeeah, S., Ravinetto, R. and Tomas, A. (2025). Dispensing of medicines for asthma and chronic obstructive pulmonary disease through the government health insurance in Syria: a retrospective analysis. Global Health Action, 18(1). doi:https://doi.org/10.1080/16549716.2025.2556526.

Marques, L. and Vale, N. (2022). Salbutamol in the management of asthma: A review. International Journal of Molecular Sciences, [online] 23(22). doi:https://doi.org/10.3390/ijms232214207.

UK Government (2025). Respiratory disease profile: statistical commentary, June 2025. [online] GOV.UK. Available at: https://www.gov.uk/government/statistics/update-of-indicators-in-the-respiratory-disease-profile-june-2025/respiratory-disease-profile-statistical-commentary-june-2025.

UK Government (2025). Short-acting beta 2 agonists (SABA) (salbutamol and terbutaline): reminder of the risks from overuse in asthma and to be aware of changes in the SABA prescribing guidelines. [online] GOV.UK. Available at: https://www.gov.uk/drug-safety-update/short-acting-beta-2-agonists-saba-salbutamol-and-terbutaline-reminder-of-the-risks-from-overuse-in-asthma-and-to-be-aware-of-changes-in-the-saba-prescribing-guidelines#.


