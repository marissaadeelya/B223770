---
title: "How do salbutamol prescriptions in Scotland vary by season, and to what extent are these patterns influenced by age groups?"
author: "Marissa Mansor"
date: "26 November 2025"
output:
  html_document:
    toc: true
    toc_float: true
    theme: lumen
    code_download: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = FALSE, message = FALSE)
```

## Background: Burden of Respiratory Conditions and the Role of Salbutamol

Emergency admissions for respiratory diseases, including asthma and chronic obstructive pulmonary disease (COPD), have increased in recent years. In 2024, England recorded 854,922 emergency admissions, representing a 7% rise from the previous year (UK Government, 2025)((https://www.gov.uk/government/statistics/update-of-indicators-in-the-respiratory-disease-profile-june-2025/respiratory-disease-profile-statistical-commentary-june-2025).

To reduce hospitalisations and manage symptoms, salbutamol is widely used as the first selective short-acting β₂-agonist (SABA) for asthma treatment. It relaxes airway smooth muscle, improving breathing during episodes of respiratory distress or flare-ups. Salbutamol is considered one of the most effective and safest essential medicines and is available in several formulations, including inhalers, nebulisers, and tablets (Marques and Vale,2022)(https://pmc.ncbi.nlm.nih.gov/articles/PMC9696300/).

## Study Motivation: Seasonal Fluctuations in Respiratory Medication Demand

A study in Syria reported seasonal variation in the dispensing of medicines for asthma and COPD, with higher rates in autumn and winter and lower rates in summer (Aljadeeah et al., 2025)(https://doi.org/10.1080/16549716.2025.2556526). Building on this, this report investigates whether seasonal patterns exist in salbutamol prescribing across Scotland and explores NHS board-level population structure, in terms of age and sex distributions to contextualise potential differences in prescribing trends.

## About the Data
The prescription data used in this study were obtained from Public Health Scotland, specifically from the Data by Prescriber Location dataset. 24 monthly files (one file per month) covering the period June 2023 to May 2025 were utilised, providing detailed records of items prescribed in the community.

To support reproducibility, the download links for all 24 CSV files were compiled into a single CSV file and made available via GitHub.

```{r Load libraries and data from June 2023 to May 2025}
library(tidyverse)
library(janitor)
library(here)
library(gt)

# Read URL list from GitHub csv file for reproducibility
urls_list <- read_csv( "https://raw.githubusercontent.com/marissaadeelya/B223770/main/urls.csv") %>%
  pull(url)

# Introducing data from June 2023 to May 2025 
consecutive_data <- urls_list %>% 
  map_dfr(~ read_csv(.x, col_types = cols(.default = col_character()))) %>%
  clean_names() %>%
  select(hbt, bnf_item_description, paid_quantity, paid_date_month)

```

## Introducing Salbutamol Data by Season for 2 Complete Cycles (June 2023 - May 2025)
This section filters data to focus only on salbutamol prescriptions, excluding the non-official NHS health board code (SB0806). 

```{r Classify salbutamol prescription by season}

# Filter salbutamol prescription and classify months
salbutamol_data <- consecutive_data %>%
  filter(str_detect(bnf_item_description, "SALBUTAMOL"),
         hbt != "SB0806") %>%
  mutate(
    paid_quantity = as.numeric(paid_quantity),
    paid_date_month = parse_date_time(paid_date_month, "ym"),
    month_number = month(paid_date_month),
    
# Custom year into 2023/2024 and 2024/2025. 'paste0()' joins years without inserting a space
    year = case_when(
      month_number >= 6 ~ paste0(year(paid_date_month), "/", year(paid_date_month) + 1),
           TRUE ~ paste0(year(paid_date_month) - 1, "/", year(paid_date_month))),

# Convert months into seasons        
 season = case_when(
           month_number %in% c(12, 1, 2) ~ "Winter",
           month_number %in% c(3, 4, 5) ~ "Spring",
           month_number %in% c(6, 7, 8) ~ "Summer",
           month_number %in% c(9, 10, 11) ~ "Autumn"),
         season = factor(season, levels = c("Summer", "Autumn", "Winter", "Spring"))) %>%
  group_by(paid_date_month, hbt, bnf_item_description, season, year) %>%
  summarise(total_prescriptions = sum(paid_quantity, na.rm = TRUE), .groups = "drop")

```

## Aim 1: To investigate if salbutamol prescriptions fluctuate by season across Scotland.

The dataset was generated by aggregating all salbutamol prescriptions, irrespective of formulation type, across all Scottish Health Boards. This provides a national-level perspective on seasonal variation, as illustrated in Figure 1.

```{r Plot (Figure 1) seasonal trend across Scotland, fig.width=7, fig.height= 5}

# Aggregate data across all boards for seasonal national-level view
seasonal_salbutamol <- salbutamol_data %>%
  group_by(season, year) %>%
  summarise(
    total_prescriptions = sum(total_prescriptions, na.rm = TRUE),
    .groups = "drop")

# Define a custom plotting function for line charts
line_charts_custom <- function(df, x_var, y_var, colour_var, group_var,size, y_label, title, base_size) 
  { df %>% 
    ggplot(aes(
      x = {{ x_var }},
      y = {{ y_var }},
      colour = {{ colour_var }},
      group = {{ group_var }}       
    )) +
    geom_line(linewidth = 1.2) +
    geom_point(size=size) +
    scale_y_continuous(labels = scales::comma) +
    scale_color_brewer(palette = "Set1") +
    labs(
      title = title,
      subtitle = "Each line represents a June–May year period",  
      x = "Season",
      y = y_label,
      colour = "Year Group (June–May)"
    ) +
    theme_bw(base_size) +
    theme(
      plot.title = element_text(face = "bold", size = 13, hjust = 0.5),
      plot.subtitle = element_text(hjust = 0.5),
      axis.text.x = element_text(angle = 30, hjust = 1),
      legend.position ="bottom",
      legend.text = element_text(size = 11),strip.text = element_text(face ="bold"))}

# Plot Figure 1 (Prescription Seasonal Trend in Scotland)
plot_seasonal_trend <- seasonal_salbutamol %>% 
  line_charts_custom(season, total_prescriptions, year,year, 4, "Total Prescriptions", "Seasonal Distribution of Salbutamol Prescriptions in Scotland", 12)

plot_seasonal_trend 

```

Figure 1 shows a clear seasonal pattern in salbutamol prescribing across Scotland, with winter peaks, stable summer and autumn levels, and sharp declines in spring over two consecutive years. This reflects higher respiratory infection rates and asthma exacerbations in colder months, with reduced symptoms in spring due to milder conditions and lower viral activity. Prescriptions rise again in summer, likely linked to grass pollen exposure that may affect asthma patients.

Overall prescribing is lower this year than last year, which may reflect updated clinical guidelines that advise against prescribing SABA, including salbutamol, on its own without a concurrent inhaled corticosteroid, and instead recommend anti-inflammatory reliever (AIR) therapy as a safer alternative for long-term asthma management (UK Government, 2025)https://www.gov.uk/drug-safety-update/short-acting-beta-2-agonists-saba-salbutamol-and-terbutaline-reminder-of-the-risks-from-overuse-in-asthma-and-to-be-aware-of-changes-in-the-saba-prescribing-guidelines#:~:text=The%20UK%20asthma%20guidelines%20%5Bfootnote,if%20asthma%20control%20is%20suboptimal).


## Aim 2: Comparing Salbutamol Prescriptions Trend by NHS Board

The next step is to examine whether this seasonal pattern is consistent across different NHS Boards. To do this, the Health Board names dataset from the Public Health Scotland Open Data website is required to later join with the prescriptions dataset and identify the board for each record.

While total prescriptions show a clear seasonal trend, these numbers are affected by differences in population size between NHS Boards. To make comparisons meaningful, prescription rates were therefore calculated per head using NHS Board population estimates.

This requires an additional population dataset from the 2022 Census, which provides the number of people living in each NHS Board, broken down by age group and sex. To include this information, download the file UV102a_age_health_board_census.csv from Scotland’s Census website (https://www.scotlandscensus.gov.uk/webapi/jsf/tableView/tableView.xhtml
) and save it in the data subfolder of your 'B223770' project folder.

```{r Load healthboard and population data set}

# Load & clean healthboard data
hb_lookup <-
  read_csv("https://www.opendata.nhs.scot/dataset/9f942fdb-e59e-44f5-b534-d6e17229cc7b/resource/652ff726-e676-4a20-abda-435b98dd7bdc/download/hb14_hb19.csv",
  col_types = cols(.default = col_character())) %>%
  clean_names() %>%
  select(hb, hb_name) %>%
  filter(!duplicated(hb_name))

# Load & clean population data
population_data <-read_csv( here("data", "UV102a_age_health_board_census.csv"),
    skip = 10,
    col_types = cols(.default = col_character())) %>%
  clean_names() %>%
  rename(spare = x6,
         hb_name = health_board_area_2019,
         hb_population = count) %>%
  mutate(hb_name = paste("NHS", hb_name)) %>%
  filter(!is.na(hb_population)) %>%
  select(-spare, hb_name, age, sex, hb_population)
```

## Figure 2: Prescription Trend by NHS Board

Join the `population_data` file with your main data file, so you can see the population of each healthboard.

```{r Categorise NHS boards into regions}

# A reusable function (add_region) was created to assign NHS Boards to regions in different datasets. 
add_region <- function(df) {
  df %>%
    mutate(
      region = case_when(
        hb_name %in% c(
          "NHS Highland", "NHS Grampian", "NHS Tayside",
          "NHS Orkney", "NHS Shetland", "NHS Western Isles"
        ) ~ "North",
        hb_name %in% c(
          "NHS Greater Glasgow and Clyde", "NHS Lanarkshire",
          "NHS Ayrshire and Arran", "NHS Forth Valley"
        ) ~ "Central",
        hb_name %in% c(
          "NHS Lothian", "NHS Borders", "NHS Fife",
          "NHS Dumfries and Galloway"
        ) ~ "South",
        TRUE ~ "Other"
      ))}
```

```{r Plot (Figure 2) Prescription Trend by NHS Board, fig.width=8, fig.height=5 }

# Joining (refer to notes)

hb_salbutamol_data <- salbutamol_data %>% 
  left_join(hb_lookup, by = c("hbt"="hb")) %>% 
  filter(!is.na(hb_name)) %>% 
  select(hbt,hb_name, season, year, total_prescriptions)

hb_per_head_salbutamol_data <- hb_salbutamol_data %>% 
  left_join(
    population_data %>% 
      filter(age == "All people", sex == "All people") %>% 
      distinct(hb_name, .keep_all = TRUE) %>% 
      mutate(hb_population = as.numeric(hb_population)),  
    by = "hb_name"
  ) %>%  
  group_by(hb_name, season, year) %>% 
  summarise(
    prescriptions_per_head = sum(total_prescriptions, na.rm = TRUE) / unique(hb_population),
    .groups = "drop"
  ) %>% 
  add_region()

# Plot Figure 2 to show seasonal prescriptions by NHS Boards
plot_hb_trend_per_head <- hb_per_head_salbutamol_data %>% 
  line_charts_custom(season, prescriptions_per_head, factor(year),interaction(hb_name, year), 2,"Total Prescriptions per Head", "Seasonal Salbutamol Prescriptions per Head by NHS Boards", 10) + facet_wrap(region~ hb_name,scales ="free_y") + labs(
    caption = "Note: NHS Boards are categorised into three regions - Central, North and South."
  ) +
  theme(
    plot.caption = element_text(
      size = 12,      # increase caption size
      hjust = 0.5))

plot_hb_trend_per_head
```

Figure 2:

Higher prescription overall - South region, Forth Valley (central), Less prescription in North (comment on limited access to gp etc + suggest reference)
BUT,
alert with winter time, 
Regardless of region, it depends on accessibility for prescription
All drop during spring
Drastic peak for north region (grampian, orkney)

Despite colder winters in northern Scotland, salbutamol prescribing is higher in NHS Ayrshire and Arran than NHS Highland. This pattern reflects the influence of population density, urbanization, and socioeconomic factors on respiratory disease prevalence and healthcare utilization. Urban areas experience higher air pollution and allergen exposure, increasing the risk of asthma exacerbations, while greater access to primary care facilitates more frequent prescription of rescue medication. Conversely, northern regions are more sparsely populated, less deprived, and have longer distances to healthcare services, contributing to lower overall prescription rates despite colder temperatures.


## Aim 3 - Population-Context

Since all NHS Boards showed a similar winter peak, the next step was to examine whether this seasonal increase differs by region and age group. Two NHS Boards were selected to represent contrasting winter climates in Scotland: a colder northern region (NHS Highland) and a milder southern region (NHS Ayrshire and Arran), allowing comparison of the magnitude and age distribution of salbutamol prescriptions in winter.

Hint: Age-specific prescription counts were not available. Therefore, prescriptions were allocated proportionally based on each age group's share of the NHS Board population. These values represent population-weighted estimates, not actual prescribing rates.

```{r Age group setup}

population_summary <- population_data %>%
  mutate(
    hb_population = as.numeric(hb_population),
    age_group = case_when(
      age == "Under 1" ~ "0-1",
      age %in% as.character(1:17) ~ "1-17",
      age %in% as.character(18:39) ~ "18-39",
      age %in% as.character(40:64) ~ "40-64",
      age %in% as.character(65:84) ~ "65-84",
      age == "85 and over" ~ "85+"
    ),
    age_group = factor(age_group, 
                       levels = c("0-1","1-17","18-39","40-64","65-84","85+"))
  ) %>%
  add_region() %>%   # ← now correctly placed *after* mutate()
  filter(!is.na(age_group), sex %in% c("Female", "Male")) %>%
  group_by(region, hb_name, age_group, sex) %>%
  summarise(population = sum(hb_population, na.rm = TRUE), .groups = "drop")

```



```{r Prepare population data}

# Calculate population + percentage
region_population <- population_summary %>%
  group_by(region, age_group, sex) %>%
  summarise(population = sum(population), .groups = "drop") %>%
  group_by(region) %>%
  mutate(
    region_total = sum(population),
    percentage = (population / region_total) * 100
  ) %>%
  ungroup()

# Pivot wider with original names
region_table <- region_population %>%
  select(region, age_group, sex, percentage) %>%
  pivot_wider(
    names_from = sex,
    values_from = percentage,
  ) %>%
  group_by(region, age_group) %>%
  summarise(
    Male = sum(Male),
    Female = sum(Female),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from = region,
    values_from = c(Male, Female)
    ) %>%
  arrange(match(age_group, c("0-1","1-17","18-39","40-64","65-84","85+")))

# Add total row
region_table <- region_table %>%
  bind_rows(
    summarise(.,
      across(where(is.numeric), ~ sum(.x, na.rm = TRUE)),
      age_group = "Total"))

# Identify max age group (excluding Total)
max_age <- region_table %>%
  filter(age_group != "Total") %>%
  rowwise() %>%   # to find maximum value row by row
  mutate(
    max_val = max(c_across(where(is.numeric)), na.rm = TRUE)) %>%
  ungroup() %>%
  slice_max(max_val) %>%
  pull(age_group)


```

```{r Table (figure 3): summarising population by region and age group }

## create 'apply_style' function to easily apply tab_style() in different ways (gt table)

apply_style <- function(df, fill_col, text_col, locations) {
  df %>% 
    gt::tab_style(
      style = list(
        cell_fill(color = fill_col),
        cell_text(color = text_col, weight = "bold", size = "large")),
      locations = {{ locations }})}

## generate table (figure 3)
region_gt_table <- region_table %>%
  gt() %>%
  fmt_number(columns = where(is.numeric), decimals = 2) %>%
  tab_header(
    title = "Population by Region and Age Group",
    subtitle = "Distribution of population percentages by sex within each region") %>%
  
  # to create column groupings by region for each sex
  tab_spanner(label = "North (%)", columns = c(Male_North, Female_North)) %>%
  tab_spanner(label = "Central (%)", columns = c(Male_Central, Female_Central)) %>%
  tab_spanner(label = "South (%)", columns = c(Male_South, Female_South))  %>%
  
  cols_label(
    Male_North = "Male",
    Female_North = "Female",
    Male_Central = "Male",
    Female_Central = "Female",
    Male_South = "Male",
    Female_South = "Female",
    age_group = "Age Group") %>%
  
  # utilise apply_style function 
  apply_style("darkblue","white", cells_title(groups = "title")) %>% 
  apply_style("lightblue","black", cells_title(groups = "subtitle")) %>% 
  apply_style("orange","black", cells_body(rows = age_group == max_age)) %>% 
  apply_style("grey","black", cells_body(rows = age_group == "Total")) %>%

  cols_align(align = "center", columns = everything()) %>%
  tab_source_note(
    source_note = "All values represent the percentage of the total population within each region. The orange-highlighted row indicates the age group with the highest population proportion in that region.") %>%
  
  cols_width(everything() ~ px(95)) 
  
region_gt_table

```


```{r Heatmap (figure 4), fig.width= 10}


# data being plotted is the raw population counts
heatmap <- ggplot(population_summary, aes(
  x = age_group,
  y = hb_name,
  fill = population
)) +
  geom_tile() +

  # Colour scale using log10 for better visibility
  scale_fill_distiller(
    palette = "RdBu",
    direction = -1,               # -1 = blue low to red high
    trans = "log10",
    name = "Population\n",
    labels = scales::label_number(scale_cut = scales::cut_short_scale())
  # legend labels in 1k, 1M, etc.
  ) +

  # Facet boards by Region (rows) and Sex (columns)
  facet_grid(region ~ sex, scales = "free_y", space = "free_y") +

  # Labels
  labs(
    title = "Population Heatmap by NHS Board, Age Group, Sex, and Region",
    x = "Age Group",
    y = "NHS Board",
    caption = "Note: Colour Colour intensity is based on log10 of raw population counts to improve visibility across NHS boards of very different sizes."
  ) +

  theme_minimal() +
  theme(
    plot.caption = element_text(size = 11,hjust = 0.5),
    axis.text.y = element_text(size = 7),
    strip.text = element_text(face = "bold", size = 10),
    plot.title = element_text(face = "bold", hjust = 0.5))

heatmap

```



Although population structure (age and sex distribution) was summarised for each NHS region, these data cannot be used to infer which age groups contribute most to salbutamol prescribing. Prescribing is driven by underlying respiratory disease prevalence, not population size, and the absence of age-linked prescribing data prevents any direct age-group comparisons.

Although population structure (age and sex distribution) was summarised for each NHS region, these data were included as contextual demographic information rather than predictors of salbutamol prescribing. Prescribing activity is primarily driven by the underlying prevalence and severity of asthma and other respiratory conditions, which do not necessarily align with population size in each age group. Without age-specific prescribing data, it is not possible to determine which age groups contribute most to SABA use. However, presenting population structure remains valuable in this report as it helps situate prescribing patterns within the broader demographic landscape of each NHS board, highlights regional differences that may influence service planning, and provides a foundation for future analyses that could integrate age-stratified prescribing or disease-prevalence data.

While population structure does not directly explain salbutamol prescribing patterns, its inclusion enhances interpretation of regional trends by illustrating the demographic context in which prescribing occurs. These demographic patterns may influence long-term service demand, respiratory risk profiles, and public-health planning. Therefore, although not used for causal inference, demographic data contribute to a more comprehensive understanding of the prescribing landscape.

## Limitations:
- Measurement based on proportion, not from actual data, therefore comparing two different geographical areas
- Age group (proportion), cannot see significant % changes pattern between years -> identical %

A key limitation of this analysis is that the prescribing dataset does not include information on patient age, meaning prescriptions cannot be linked to specific age groups. Although age-specific population data are available for each NHS board, the total number of salbutamol prescriptions is only reported at board level, without breakdown by age. As a result, it is not possible to determine which age group actually has the highest prescribing rate or contributes most to the winter peak. Any attempt to estimate prescribing by age would rely on population proportions rather than true prescribing behaviour, which would be statistically invalid and potentially misleading. Therefore, age-group comparisons are not conducted, and all interpretations are limited to board-level prescribing rates.

## Conclusion
This study provides a meaningful assessment of salbutamol prescribing patterns at both national and NHS board levels, highlighting consistent seasonal trends and regional variation. By expressing prescribing on a per-head basis, fair comparisons between regions are possible, and population distributions by age and sex offer contextual insight into which groups are likely to contribute most to total prescriptions. However, a key limitation is the absence of age-specific prescribing data, meaning actual prescribing rates for specific age groups cannot be determined. Consequently, inferences regarding the contribution of different age groups are based solely on population size rather than observed prescribing behaviour. Despite this, the findings remain relevant for understanding overall prescribing patterns and informing resource planning and seasonal preparedness.

(forecasting,regional respiratory health comparisons)

healthcare service allocation)

## Future Direction:
Once getting actual prescriptions data for age-group and sex, apply for diff NHS board to get better overview of prescriptions, better repiratory care understanding

## References
GOV.UK (2025). Respiratory disease profile: statistical commentary, June 2025. [online] GOV.UK. Available at: https://www.gov.uk/government/statistics/update-of-indicators-in-the-respiratory-disease-profile-june-2025/respiratory-disease-profile-statistical-commentary-june-2025.

